# Roomify Backend - .NET RESTful API Architecture Plan
## Senior Software Engineering Level Design

**Framework:** .NET 8.0 (or latest LTS)  
**Architecture:** RESTful API with Clean Architecture principles  
**Database:** SQL Server / PostgreSQL  
**Authentication:** JWT Bearer Tokens  
**Date:** January 2025

---

## Table of Contents

1. [Project Structure](#project-structure)
2. [Database Schema Design](#database-schema-design)
3. [API Endpoints Specification](#api-endpoints-specification)
4. [Architecture Patterns](#architecture-patterns)
5. [Security Implementation](#security-implementation)
6. [Implementation Phases](#implementation-phases)
7. [Technology Stack](#technology-stack)

---

## Project Structure

```
Roomify.API/
├── Controllers/
│   ├── AuthController.cs
│   ├── UsersController.cs
│   ├── ListingsController.cs
│   ├── BookingsController.cs
│   ├── ReviewsController.cs
│   ├── PaymentsController.cs
│   ├── SearchController.cs
│   ├── ImagesController.cs
│   ├── NotificationsController.cs
│   └── AdminController.cs
│
├── Data/
│   ├── ApplicationDbContext.cs
│   ├── DbInitializer.cs
│   └── Repositories/
│       ├── IUserRepository.cs
│       ├── UserRepository.cs
│       ├── IListingRepository.cs
│       ├── ListingRepository.cs
│       ├── IBookingRepository.cs
│       ├── BookingRepository.cs
│       ├── IReviewRepository.cs
│       ├── ReviewRepository.cs
│       └── IUnitOfWork.cs
│       └── UnitOfWork.cs
│
├── Models/
│   ├── Entities/
│   │   ├── User.cs
│   │   ├── Listing.cs
│   │   ├── Booking.cs
│   │   ├── Review.cs
│   │   ├── Payment.cs
│   │   ├── Image.cs
│   │   ├── Amenity.cs
│   │   ├── PropertyType.cs
│   │   ├── Notification.cs
│   │   ├── Address.cs
│   │   └── RefreshToken.cs
│   │
│   ├── Enums/
│   │   ├── UserRole.cs
│   │   ├── BookingStatus.cs
│   │   ├── PaymentStatus.cs
│   │   ├── PaymentMethod.cs
│   │   ├── PropertyTypeEnum.cs
│   │   └── NotificationType.cs
│   │
│   └── ViewModels/
│       ├── PaginationParams.cs
│       ├── SearchParams.cs
│       └── FilterParams.cs
│
├── DTOs/
│   ├── Request/
│   │   ├── Auth/
│   │   │   ├── LoginRequestDto.cs
│   │   │   ├── RegisterRequestDto.cs
│   │   │   ├── RefreshTokenRequestDto.cs
│   │   │   └── ForgotPasswordRequestDto.cs
│   │   │
│   │   ├── User/
│   │   │   ├── UpdateUserRequestDto.cs
│   │   │   ├── ChangePasswordRequestDto.cs
│   │   │   └── UpdateProfileRequestDto.cs
│   │   │
│   │   ├── Listing/
│   │   │   ├── CreateListingRequestDto.cs
│   │   │   ├── UpdateListingRequestDto.cs
│   │   │   └── ListingSearchRequestDto.cs
│   │   │
│   │   ├── Booking/
│   │   │   ├── CreateBookingRequestDto.cs
│   │   │   ├── UpdateBookingRequestDto.cs
│   │   │   ├── CancelBookingRequestDto.cs
│   │   │   └── BookingSearchRequestDto.cs
│   │   │
│   │   ├── Review/
│   │   │   ├── CreateReviewRequestDto.cs
│   │   │   └── UpdateReviewRequestDto.cs
│   │   │
│   │   └── Payment/
│   │       ├── ProcessPaymentRequestDto.cs
│   │       ├── RefundPaymentRequestDto.cs
│   │       └── PaymentIntentRequestDto.cs
│   │
│   └── Response/
│       ├── Auth/
│       │   ├── AuthResponseDto.cs
│       │   └── TokenResponseDto.cs
│       │
│       ├── User/
│       │   ├── UserResponseDto.cs
│       │   ├── UserProfileResponseDto.cs
│       │   └── UserStatsResponseDto.cs
│       │
│       ├── Listing/
│       │   ├── ListingResponseDto.cs
│       │   ├── ListingDetailResponseDto.cs
│       │   └── ListingSummaryResponseDto.cs
│       │
│       ├── Booking/
│       │   ├── BookingResponseDto.cs
│       │   ├── BookingDetailResponseDto.cs
│       │   └── BookingSummaryResponseDto.cs
│       │
│       ├── Review/
│       │   ├── ReviewResponseDto.cs
│       │   └── ReviewSummaryResponseDto.cs
│       │
│       ├── Payment/
│       │   ├── PaymentResponseDto.cs
│       │   └── PaymentIntentResponseDto.cs
│       │
│       └── Common/
│           ├── ApiResponse.cs
│           ├── PagedResponse.cs
│           └── ErrorResponse.cs
│
├── Mapping/
│   ├── AutoMapperProfile.cs
│   ├── UserMappingProfile.cs
│   ├── ListingMappingProfile.cs
│   ├── BookingMappingProfile.cs
│   └── ReviewMappingProfile.cs
│
├── Migrations/
│   └── (Auto-generated by EF Core)
│
├── Services/
│   ├── Interfaces/
│   │   ├── IAuthService.cs
│   │   ├── IUserService.cs
│   │   ├── IListingService.cs
│   │   ├── IBookingService.cs
│   │   ├── IReviewService.cs
│   │   ├── IPaymentService.cs
│   │   ├── IImageService.cs
│   │   ├── IEmailService.cs
│   │   ├── INotificationService.cs
│   │   ├── ISearchService.cs
│   │   └── IFileStorageService.cs
│   │
│   └── Implementations/
│       ├── AuthService.cs
│       ├── UserService.cs
│       ├── ListingService.cs
│       ├── BookingService.cs
│       ├── ReviewService.cs
│       ├── PaymentService.cs
│       ├── ImageService.cs
│       ├── EmailService.cs
│       ├── NotificationService.cs
│       ├── SearchService.cs
│       └── FileStorageService.cs
│
├── Utilities/
│   ├── PasswordHasher.cs
│   ├── JwtTokenGenerator.cs
│   ├── EmailValidator.cs
│   ├── PhoneValidator.cs
│   ├── DateTimeHelper.cs
│   ├── StringExtensions.cs
│   ├── EncryptionHelper.cs
│   └── Constants.cs
│
├── Middleware/
│   ├── ExceptionHandlingMiddleware.cs
│   ├── RequestLoggingMiddleware.cs
│   ├── JwtMiddleware.cs
│   └── RateLimitingMiddleware.cs
│
├── Filters/
│   ├── ValidationFilter.cs
│   ├── AuthorizeFilter.cs
│   └── ActionLoggingFilter.cs
│
├── Validators/
│   ├── CreateListingRequestDtoValidator.cs
│   ├── CreateBookingRequestDtoValidator.cs
│   ├── RegisterRequestDtoValidator.cs
│   └── UpdateUserRequestDtoValidator.cs
│
├── Configuration/
│   ├── JwtSettings.cs
│   ├── PaymentSettings.cs
│   ├── EmailSettings.cs
│   ├── StorageSettings.cs
│   └── AppSettings.cs
│
├── Extensions/
│   ├── ServiceCollectionExtensions.cs
│   ├── ApplicationBuilderExtensions.cs
│   └── HttpContextExtensions.cs
│
├── Exceptions/
│   ├── NotFoundException.cs
│   ├── BadRequestException.cs
│   ├── UnauthorizedException.cs
│   ├── ForbiddenException.cs
│   ├── ValidationException.cs
│   └── PaymentException.cs
│
├── Helpers/
│   ├── PaginationHelper.cs
│   ├── QueryBuilder.cs
│   └── ResponseBuilder.cs
│
├── BackgroundServices/
│   ├── BookingReminderService.cs
│   ├── CleanupService.cs
│   └── EmailQueueService.cs
│
├── Program.cs
├── appsettings.json
├── appsettings.Development.json
├── appsettings.Production.json
└── Roomify.API.csproj
```

---

## Database Schema Design

### Entity Relationship Diagram Overview

```
Users (1) ────< (M) Bookings
Users (1) ────< (M) Listings (Host)
Users (1) ────< (M) Reviews
Listings (1) ────< (M) Bookings
Listings (1) ────< (M) Reviews
Listings (M) ────> (M) Amenities (Many-to-Many)
Listings (M) ────> (M) PropertyTypes (Many-to-Many)
Listings (1) ────< (M) Images
Bookings (1) ────< (1) Payments
```

### Detailed Entity Models

#### 1. User Entity
```csharp
public class User
{
    public Guid Id { get; set; }
    public string Email { get; set; }
    public string PasswordHash { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public string PhoneNumber { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public string Country { get; set; }
    public string? ProfileImageUrl { get; set; }
    public UserRole Role { get; set; }
    public bool IsEmailVerified { get; set; }
    public bool IsActive { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }
    
    // Navigation Properties
    public virtual Address? Address { get; set; }
    public virtual ICollection<Listing> Listings { get; set; }
    public virtual ICollection<Booking> Bookings { get; set; }
    public virtual ICollection<Review> Reviews { get; set; }
    public virtual ICollection<RefreshToken> RefreshTokens { get; set; }
    public virtual ICollection<Notification> Notifications { get; set; }
}
```

#### 2. Listing Entity
```csharp
public class Listing
{
    public Guid Id { get; set; }
    public Guid HostId { get; set; }
    public string Title { get; set; }
    public string Description { get; set; }
    public int MaxGuests { get; set; }
    public int Bedrooms { get; set; }
    public int Bathrooms { get; set; }
    public int Beds { get; set; }
    public decimal PricePerNight { get; set; }
    public TimeSpan CheckInTime { get; set; }
    public TimeSpan CheckOutTime { get; set; }
    public bool IsActive { get; set; }
    public bool IsPublished { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public DateTime? PublishedAt { get; set; }
    
    // Navigation Properties
    public virtual User Host { get; set; }
    public virtual Address Address { get; set; }
    public virtual ICollection<Image> Images { get; set; }
    public virtual ICollection<Booking> Bookings { get; set; }
    public virtual ICollection<Review> Reviews { get; set; }
    public virtual ICollection<ListingAmenity> ListingAmenities { get; set; }
    public virtual ICollection<ListingPropertyType> ListingPropertyTypes { get; set; }
}
```

#### 3. Booking Entity
```csharp
public class Booking
{
    public Guid Id { get; set; }
    public Guid ListingId { get; set; }
    public Guid GuestId { get; set; }
    public DateTime CheckInDate { get; set; }
    public DateTime CheckOutDate { get; set; }
    public int NumberOfGuests { get; set; }
    public int NumberOfRooms { get; set; }
    public string? RoomType { get; set; }
    public string? SpecialRequests { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal? DiscountAmount { get; set; }
    public decimal FinalAmount { get; set; }
    public BookingStatus Status { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public DateTime? CancelledAt { get; set; }
    public string? CancellationReason { get; set; }
    
    // Navigation Properties
    public virtual Listing Listing { get; set; }
    public virtual User Guest { get; set; }
    public virtual Payment? Payment { get; set; }
    public virtual Review? Review { get; set; }
}
```

#### 4. Review Entity
```csharp
public class Review
{
    public Guid Id { get; set; }
    public Guid BookingId { get; set; }
    public Guid ListingId { get; set; }
    public Guid GuestId { get; set; }
    public int Rating { get; set; } // 1-5
    public string? Comment { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public bool IsVisible { get; set; }
    
    // Navigation Properties
    public virtual Booking Booking { get; set; }
    public virtual Listing Listing { get; set; }
    public virtual User Guest { get; set; }
}
```

#### 5. Payment Entity
```csharp
public class Payment
{
    public Guid Id { get; set; }
    public Guid BookingId { get; set; }
    public decimal Amount { get; set; }
    public string Currency { get; set; } = "USD";
    public PaymentMethod PaymentMethod { get; set; }
    public PaymentStatus Status { get; set; }
    public string? PaymentIntentId { get; set; } // Stripe/PayPal ID
    public string? TransactionId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? CompletedAt { get; set; }
    public DateTime? RefundedAt { get; set; }
    public decimal? RefundAmount { get; set; }
    public string? RefundReason { get; set; }
    
    // Navigation Properties
    public virtual Booking Booking { get; set; }
}
```

#### 6. Image Entity
```csharp
public class Image
{
    public Guid Id { get; set; }
    public Guid ListingId { get; set; }
    public string Url { get; set; }
    public string? ThumbnailUrl { get; set; }
    public int DisplayOrder { get; set; }
    public bool IsPrimary { get; set; }
    public long FileSize { get; set; }
    public string ContentType { get; set; }
    public DateTime UploadedAt { get; set; }
    
    // Navigation Properties
    public virtual Listing Listing { get; set; }
}
```

#### 7. Address Entity
```csharp
public class Address
{
    public Guid Id { get; set; }
    public string Street { get; set; }
    public string City { get; set; }
    public string State { get; set; }
    public string Country { get; set; }
    public string PostalCode { get; set; }
    public decimal? Latitude { get; set; }
    public decimal? Longitude { get; set; }
    
    // Navigation Properties
    public virtual Listing? Listing { get; set; }
    public virtual User? User { get; set; }
}
```

#### 8. Amenity Entity (Many-to-Many with Listing)
```csharp
public class Amenity
{
    public Guid Id { get; set; }
    public string Name { get; set; }
    public string? Icon { get; set; }
    public string? Category { get; set; }
    
    // Navigation Properties
    public virtual ICollection<ListingAmenity> ListingAmenities { get; set; }
}

public class ListingAmenity
{
    public Guid ListingId { get; set; }
    public Guid AmenityId { get; set; }
    
    // Navigation Properties
    public virtual Listing Listing { get; set; }
    public virtual Amenity Amenity { get; set; }
}
```

#### 9. PropertyType Entity (Many-to-Many with Listing)
```csharp
public class PropertyType
{
    public Guid Id { get; set; }
    public string Name { get; set; } // Hotel, Apartment, Villa, Resort, etc.
    public string? Description { get; set; }
    
    // Navigation Properties
    public virtual ICollection<ListingPropertyType> ListingPropertyTypes { get; set; }
}

public class ListingPropertyType
{
    public Guid ListingId { get; set; }
    public Guid PropertyTypeId { get; set; }
    
    // Navigation Properties
    public virtual Listing Listing { get; set; }
    public virtual PropertyType PropertyType { get; set; }
}
```

#### 10. Notification Entity
```csharp
public class Notification
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public NotificationType Type { get; set; }
    public string Title { get; set; }
    public string Message { get; set; }
    public bool IsRead { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? RelatedEntityId { get; set; } // BookingId, ListingId, etc.
    
    // Navigation Properties
    public virtual User User { get; set; }
}
```

#### 11. RefreshToken Entity
```csharp
public class RefreshToken
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Token { get; set; }
    public DateTime ExpiresAt { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? RevokedByIp { get; set; }
    public DateTime? RevokedAt { get; set; }
    public bool IsActive => RevokedAt == null && ExpiresAt > DateTime.UtcNow;
    
    // Navigation Properties
    public virtual User User { get; set; }
}
```

### Enums

```csharp
public enum UserRole
{
    Guest = 0,
    Host = 1,
    Admin = 2
}

public enum BookingStatus
{
    Pending = 0,
    Confirmed = 1,
    Completed = 2,
    Cancelled = 3,
    Refunded = 4
}

public enum PaymentStatus
{
    Pending = 0,
    Processing = 1,
    Completed = 2,
    Failed = 3,
    Refunded = 4,
    PartiallyRefunded = 5
}

public enum PaymentMethod
{
    CreditCard = 0,
    DebitCard = 1,
    PayPal = 2,
    BankTransfer = 3
}

public enum NotificationType
{
    BookingConfirmed = 0,
    BookingCancelled = 1,
    PaymentReceived = 2,
    ReviewReceived = 3,
    ListingPublished = 4,
    SystemMessage = 5
}
```

---

## API Endpoints Specification

### Base URL
```
https://api.roomify.com/api/v1
```

### Authentication Endpoints

#### POST /api/v1/auth/register
**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "firstName": "John",
  "lastName": "Doe",
  "phoneNumber": "+1234567890",
  "country": "US"
}
```
**Response:** `201 Created`
```json
{
  "success": true,
  "data": {
    "userId": "guid",
    "email": "user@example.com",
    "token": "jwt-token",
    "refreshToken": "refresh-token",
    "expiresAt": "2025-01-15T10:30:00Z"
  }
}
```

#### POST /api/v1/auth/login
**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```
**Response:** `200 OK`

#### POST /api/v1/auth/refresh-token
**Request:**
```json
{
  "refreshToken": "refresh-token"
}
```

#### POST /api/v1/auth/forgot-password
#### POST /api/v1/auth/reset-password
#### POST /api/v1/auth/logout

### User Endpoints

#### GET /api/v1/users/me
#### PUT /api/v1/users/me
#### PATCH /api/v1/users/me/password
#### GET /api/v1/users/{id}
#### GET /api/v1/users/me/bookings
#### GET /api/v1/users/me/listings

### Listing Endpoints

#### GET /api/v1/listings
**Query Parameters:**
- `page` (int)
- `pageSize` (int)
- `propertyType` (string)
- `minPrice` (decimal)
- `maxPrice` (decimal)
- `guests` (int)
- `checkIn` (date)
- `checkOut` (date)
- `city` (string)
- `country` (string)
- `amenities` (string[]) - comma-separated
- `sortBy` (string) - price, rating, newest
- `sortOrder` (string) - asc, desc

**Response:** `200 OK`
```json
{
  "success": true,
  "data": {
    "items": [...],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "totalCount": 150,
      "totalPages": 8
    }
  }
}
```

#### GET /api/v1/listings/{id}
#### POST /api/v1/listings
#### PUT /api/v1/listings/{id}
#### DELETE /api/v1/listings/{id}
#### POST /api/v1/listings/{id}/images
#### DELETE /api/v1/listings/{id}/images/{imageId}
#### GET /api/v1/listings/{id}/availability

### Booking Endpoints

#### GET /api/v1/bookings
#### GET /api/v1/bookings/{id}
#### POST /api/v1/bookings
**Request:**
```json
{
  "listingId": "guid",
  "checkInDate": "2025-02-15",
  "checkOutDate": "2025-02-20",
  "numberOfGuests": 2,
  "numberOfRooms": 1,
  "roomType": "Double",
  "specialRequests": "Late check-in please"
}
```
#### PUT /api/v1/bookings/{id}
#### POST /api/v1/bookings/{id}/cancel
#### GET /api/v1/bookings/{id}/receipt

### Review Endpoints

#### GET /api/v1/listings/{listingId}/reviews
#### POST /api/v1/bookings/{bookingId}/review
#### PUT /api/v1/reviews/{id}
#### DELETE /api/v1/reviews/{id}

### Payment Endpoints

#### POST /api/v1/payments/intent
**Request:**
```json
{
  "bookingId": "guid",
  "amount": 500.00,
  "currency": "USD"
}
```
**Response:**
```json
{
  "success": true,
  "data": {
    "clientSecret": "stripe-client-secret",
    "paymentIntentId": "pi_xxx"
  }
}
```

#### POST /api/v1/payments/confirm
#### POST /api/v1/payments/{id}/refund

### Search Endpoints

#### GET /api/v1/search/listings
**Query Parameters:** Same as GET /api/v1/listings

### Image Endpoints

#### POST /api/v1/images/upload
#### DELETE /api/v1/images/{id}

### Notification Endpoints

#### GET /api/v1/notifications
#### PUT /api/v1/notifications/{id}/read
#### PUT /api/v1/notifications/read-all

---

## Architecture Patterns

### 1. Repository Pattern
- Abstract data access logic
- Unit of Work pattern for transaction management
- Interface-based design for testability

### 2. Service Layer Pattern
- Business logic separation
- Dependency injection
- Interface-based services

### 3. DTO Pattern
- Request/Response separation
- Data transformation
- API versioning support

### 4. CQRS (Command Query Responsibility Segregation)
- Separate read/write operations
- Optimized queries
- Better scalability

### 5. Middleware Pipeline
- Exception handling
- Request logging
- Authentication/Authorization
- Rate limiting

---

## Security Implementation

### 1. Authentication
- JWT Bearer tokens
- Refresh token rotation
- Password hashing (BCrypt/Argon2)
- Email verification

### 2. Authorization
- Role-based access control (RBAC)
- Policy-based authorization
- Resource-level permissions

### 3. Data Protection
- Input validation (FluentValidation)
- SQL injection prevention (EF Core parameterized queries)
- XSS prevention
- CSRF protection

### 4. Payment Security
- PCI-DSS compliance
- Tokenization (Stripe/PayPal)
- No card data storage
- Secure payment processing

### 5. API Security
- HTTPS only
- Rate limiting
- CORS configuration
- API versioning

---

## Technology Stack

### Core Framework
- **.NET 8.0** (or latest LTS)
- **ASP.NET Core Web API**
- **Entity Framework Core 8.0**

### Database
- **SQL Server** or **PostgreSQL**
- **EF Core Migrations**

### Authentication
- **Microsoft.AspNetCore.Authentication.JwtBearer**
- **BCrypt.Net-Next** or **Argon2**

### Validation
- **FluentValidation**

### Mapping
- **AutoMapper**

### Payment Processing
- **Stripe.NET** or **PayPal SDK**

### Email Service
- **SendGrid** or **AWS SES**
- **MailKit**

### File Storage
- **AWS S3** or **Azure Blob Storage**
- **Cloudinary** (for image optimization)

### Logging
- **Serilog**
- **Application Insights** (Azure)

### Caching
- **Redis** (optional, for high traffic)

### Testing
- **xUnit**
- **Moq**
- **FluentAssertions**
- **Integration Tests**

### Documentation
- **Swagger/OpenAPI**

---

## Implementation Phases

### Phase 1: Foundation (Week 1-2)
1. Project setup and structure
2. Database design and migrations
3. Base entities and DbContext
4. Repository pattern implementation
5. Unit of Work pattern
6. Basic authentication (JWT)

### Phase 2: Core Features (Week 3-4)
1. User management (CRUD)
2. Listing management (CRUD)
3. Image upload service
4. Search functionality
5. Basic booking creation

### Phase 3: Booking & Payments (Week 5-6)
1. Complete booking system
2. Payment integration (Stripe/PayPal)
3. Booking status management
4. Cancellation logic
5. Refund processing

### Phase 4: Reviews & Notifications (Week 7)
1. Review system
2. Rating calculations
3. Notification service
4. Email service integration

### Phase 5: Advanced Features (Week 8)
1. Advanced search/filtering
2. Availability calendar
3. Host dashboard endpoints
4. Admin endpoints
5. Analytics endpoints

### Phase 6: Security & Optimization (Week 9)
1. Security hardening
2. Performance optimization
3. Caching implementation
4. Rate limiting
5. API documentation

### Phase 7: Testing & Deployment (Week 10)
1. Unit tests
2. Integration tests
3. Load testing
4. Deployment setup
5. Monitoring setup

---

## Key Implementation Details

### 1. ApplicationDbContext.cs
```csharp
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options) { }

    public DbSet<User> Users { get; set; }
    public DbSet<Listing> Listings { get; set; }
    public DbSet<Booking> Bookings { get; set; }
    public DbSet<Review> Reviews { get; set; }
    public DbSet<Payment> Payments { get; set; }
    public DbSet<Image> Images { get; set; }
    public DbSet<Address> Addresses { get; set; }
    public DbSet<Amenity> Amenities { get; set; }
    public DbSet<PropertyType> PropertyTypes { get; set; }
    public DbSet<Notification> Notifications { get; set; }
    public DbSet<RefreshToken> RefreshTokens { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Configure relationships
        // Configure indexes
        // Configure seed data
        base.OnModelCreating(modelBuilder);
    }
}
```

### 2. Password Hashing (Utilities/PasswordHasher.cs)
```csharp
public static class PasswordHasher
{
    public static string HashPassword(string password)
    {
        return BCrypt.Net.BCrypt.HashPassword(password, workFactor: 12);
    }

    public static bool VerifyPassword(string password, string hash)
    {
        return BCrypt.Net.BCrypt.Verify(password, hash);
    }
}
```

### 3. JWT Token Generation (Utilities/JwtTokenGenerator.cs)
```csharp
public class JwtTokenGenerator
{
    private readonly JwtSettings _jwtSettings;

    public string GenerateToken(User user)
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Role, user.Role.ToString())
        };

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtSettings.Secret));
        var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            issuer: _jwtSettings.Issuer,
            audience: _jwtSettings.Audience,
            claims: claims,
            expires: DateTime.UtcNow.AddMinutes(_jwtSettings.ExpirationMinutes),
            signingCredentials: credentials
        );

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}
```

### 4. Service Registration (Extensions/ServiceCollectionExtensions.cs)
```csharp
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddApplicationServices(this IServiceCollection services)
    {
        // Repositories
        services.AddScoped<IUnitOfWork, UnitOfWork>();
        services.AddScoped<IUserRepository, UserRepository>();
        services.AddScoped<IListingRepository, ListingRepository>();
        // ... other repositories

        // Services
        services.AddScoped<IAuthService, AuthService>();
        services.AddScoped<IUserService, UserService>();
        services.AddScoped<IListingService, ListingService>();
        // ... other services

        // AutoMapper
        services.AddAutoMapper(typeof(AutoMapperProfile));

        // FluentValidation
        services.AddValidatorsFromAssemblyContaining<CreateListingRequestDtoValidator>();

        return services;
    }
}
```

---

## Database Indexes

### Recommended Indexes:
```sql
-- Users
CREATE INDEX IX_Users_Email ON Users(Email);
CREATE INDEX IX_Users_Role ON Users(Role);

-- Listings
CREATE INDEX IX_Listings_HostId ON Listings(HostId);
CREATE INDEX IX_Listings_IsActive ON Listings(IsActive);
CREATE INDEX IX_Listings_IsPublished ON Listings(IsPublished);
CREATE INDEX IX_Listings_PricePerNight ON Listings(PricePerNight);
CREATE INDEX IX_Listings_CreatedAt ON Listings(CreatedAt);

-- Bookings
CREATE INDEX IX_Bookings_GuestId ON Bookings(GuestId);
CREATE INDEX IX_Bookings_ListingId ON Bookings(ListingId);
CREATE INDEX IX_Bookings_Status ON Bookings(Status);
CREATE INDEX IX_Bookings_CheckInDate ON Bookings(CheckInDate);
CREATE INDEX IX_Bookings_CheckOutDate ON Bookings(CheckOutDate);

-- Addresses (for geospatial queries)
CREATE INDEX IX_Addresses_Country ON Addresses(Country);
CREATE INDEX IX_Addresses_City ON Addresses(City);
-- Consider spatial index for Lat/Long if using SQL Server
```

---

## Environment Configuration

### appsettings.json Structure
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=...;Database=RoomifyDb;..."
  },
  "JwtSettings": {
    "Secret": "...",
    "Issuer": "RoomifyAPI",
    "Audience": "RoomifyClient",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  },
  "PaymentSettings": {
    "Stripe": {
      "SecretKey": "...",
      "PublishableKey": "...",
      "WebhookSecret": "..."
    }
  },
  "EmailSettings": {
    "SendGridApiKey": "...",
    "FromEmail": "noreply@roomify.com",
    "FromName": "Roomify"
  },
  "StorageSettings": {
    "Provider": "AWS", // or Azure, Cloudinary
    "AwsS3": {
      "BucketName": "...",
      "Region": "..."
    }
  },
  "CorsSettings": {
    "AllowedOrigins": ["https://roomify.com", "https://www.roomify.com"]
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

---

## Conclusion

This architecture provides:

✅ **Scalability** - Clean architecture, separation of concerns  
✅ **Security** - JWT auth, password hashing, input validation  
✅ **Maintainability** - Repository pattern, service layer, DTOs  
✅ **Testability** - Interface-based design, dependency injection  
✅ **Performance** - Efficient queries, caching support, indexing  
✅ **Flexibility** - Easy to extend, modify, and scale

**Estimated Development Time:** 10 weeks (1 senior developer)  
**Recommended Team:** 2-3 developers for faster delivery

---

*Architecture Plan by Senior Software Engineer*  
*Last Updated: January 2025*

